function drawJournalList(){$("#journal-list option").remove();var t="";for(var e in journal_data)if(!($.inArray(e+"",selected_journals)>-1)){var r=journal_data[e],a=r.count?r.count:0;t+="<option value='"+e+"'>"+r.title+" ("+a+")</option>"}$("#journal-list").append(t)}function drawSelectedJournals(){for(var t=0;t<selected_journals.length;t++)if(!($("#journal-filter li[journal-id='"+selected_journals[t]+"']").length>0)){var e=selected_journals[t],r=journal[selected_journals[t]],a="<li class='filter-item' journal-id='"+e+"'><span class='filter-legend'       style='background-color:"+color_scale(e)+";'></span>"+r.title+" ("+r.count+")      <span class='filter-close'       onclick='removeJournalFilter(this)'>x</span></li>";$("ul#journal-filter").append(a)}highlightJournal()}function highlightJournal(){$(".filter-item").on("mouseover",function(){hl_pinned||(hl_journal_id=$(this).attr("journal-id"),update(filter_data))}),$(".filter-item").on("mouseout",function(){hl_pinned||(hl_journal_id=null,update(filter_data))}),$(".filter-item").on("click",function(){$(this).attr("journal-id")==hl_journal_id&&hl_pinned?($(".filter-item").removeClass("pinned"),$(".filter-item").css("background-color",""),hl_pinned=!1,hl_journal_id=null):($(this).addClass("pinned"),$(this).css("background-color",$(".filter-legend",this).css("background-color")),hl_pinned=!0,hl_journal_id=$(this).attr("journal-id")),update(filter_data)})}function removeJournalFilter(t){var e=$(t).parent(),r=e.attr("journal-id");e.remove(),selected_journals=selected_journals.filter(function(t){return t!=r}),applyFilters(!0)}function filterJournals(t,e){if(0==(selected_journals=selected_journals.concat($("select#journal-list").val())).length)return $("#journal-filter i").show(),$("#filter-list h2.journal").html("Selected Journals <a onclick='clearJournalFilters();'>clear</a>"),t;$("#journal-filter i").hide(),$("#filter-list h2.journal").html("Selected Journals ("+selected_journals.length+") <a onclick='clearJournalFilters();'>clear</a>");for(var r=[],a=$.grep(t.documents,function(t,e){return $.inArray(t.journalid+"",selected_journals)>-1&&(-1==$.inArray(t.entityid+"",r)&&r.push(t.entityid),!0)}),l={documents:a,entities:getEntityList(a)},n=0;n<selected_journals.length;n++)$("#journal-list option[value='"+selected_journals[n]+"']").remove();if(e)return l;update(l)}function applyFilters(t){clearOverlay();$("select[name='start-year']").val(),$("select[name='end-year']").val();filter_data=filterDate(map_data,!0),filter_data=filterTitle(filter_data,!0),filter_data=filterJournals(filter_data,!0),drawJournalList(),filter_data=filterAuthors(filter_data,!0);var e=filter_data.documents?filter_data.documents:[];author_data=extractAuthorList(e),drawAuthorList(),t&&(drawSelectedJournals(),drawSelectedAuthors()),update(filter_data)}function clearOverlay(){for(;overlays.length>0;)overlays.pop().setMap(null)}function extractJournalList(t){var e=[];journal_data={};for(var r=0;r<t.length;r++){var a=t[r].journalid;e.includes(a)||(e.push(a),journal_data[a]=journal[a])}drawJournalList()}function removeAuthorFilter(t){var e=$(t).parent(),r=e.attr("author-id");e.remove(),selected_authors=selected_authors.filter(function(t){return t!=r}),applyFilters(!0)}function filterAuthors(t,e){if(0==(selected_authors=selected_authors.concat($("select#author-list").val())).length)return $("#author-filter i").show(),$("#filter-list h2.author").html("Selected Authors <a onclick='clearAuthorFilters();'>clear</a>"),t;$("#author-filter i").hide(),$("#filter-list h2.author").html("Selected Authors ("+selected_authors.length+") <a onclick='clearAuthorFilters();'>clear</a>");for(var r=[],a=$.grep(t.documents,function(t,e){return $.inArray(t.authorid+"",selected_authors)>-1&&(-1==$.inArray(t.entityid+"",r)&&r.push(t.entityid),!0)}),l={documents:a,entities:getEntityList(a)},n=0;n<selected_authors.length;n++)$("#author-list option[value='"+selected_authors[n]+"']").remove();if(e)return l;update(l)}function drawSelectedJournals(){for(var t=0;t<selected_journals.length;t++)if(!($("#journal-filter li[journal-id='"+selected_journals[t]+"']").length>0)){var e=selected_journals[t],r=journal[selected_journals[t]],a="<li class='filter-item' journal-id='"+e+"'><span class='filter-legend'       style='background-color:"+color_scale(e)+";'></span>"+r.title+" ("+r.count+")      <span class='filter-close'       onclick='removeJournalFilter(this)'>x</span></li>";$("ul#journal-filter").append(a)}highlightJournal()}function drawSelectedAuthors(){for(var t=0;t<selected_authors.length;t++)if(!($("#author-filter li[author-id='"+selected_authors[t]+"']").length>0)){var e=selected_authors[t],r=author_data[selected_authors[t]],a="<li class='filter-item' author-id='"+e+"'><span class='filter-legend'       style='background-color:"+color_scale(e)+";'></span>"+r.name+" ("+r.count+")      <span class='filter-close'       onclick='removeAuthorFilter(this)'>x</span></li>";$("ul#author-filter").append(a)}}function extractAuthorList(t){for(var e=[],r={},a=0;a<t.length;a++){var l=t[a].authorid;e.includes(l)?r[l].count+=1:(e.push(l),r[l]={},r[l].name=t[a].author,r[l].count=1)}return r}function drawAuthorList(){$("#author-list option").remove();var t="";for(var e in author_data)if(!($.inArray(e+"",selected_authors)>-1)){var r=author_data[e],a=r.count?r.count:0;t+="<option value='"+e+"'>"+r.name+" ("+a+")</option>"}$("#author-list").append(t)}function extractJournalEntity(t){for(var e=0;e<t.length;e++){var r=t[e].journalid,a=t[e].entityid;journal_entity_map[r]?$.inArray(a,journal_entity_map[r])<0&&journal_entity_map[r].push(a):journal_entity_map[r]=[a];var l=t[e].links;for(var n in l)entity_map[a]||(entity_map[a]=[]),-1==$.inArray(l[n],entity_map[a])&&entity_map[a].push(l[n])}}function extractDateRange(t){for(var e=9999,r=0,a=0;a<t.length;a++)t[a].year<e&&(e=t[a].year),t[a].year>r&&(r=t[a].year);populateDateRange(e,r),$("select[name='start-year'], select[name='end-year']").change(function(){applyFilters(!1)})}function populateDateRange(t,e){var r=$("#filter-date")[0];noUiSlider.create(r,{start:[t,e],connect:!0,range:{min:parseInt(t),max:parseInt(e)},tooltips:[wNumb({decimals:0}),wNumb({decimals:0})]}),$("#filter-date")[0].noUiSlider.on("update",function(){applyFilters(!1)})}function filterDate(t,e){var r=$("#filter-date")[0].noUiSlider.get(),a=parseInt(r[0]),l=parseInt(r[1]),n=[],i=t.documents.filter(function(t){return t.year>=a&&t.year<=l&&(-1==$.inArray(t.entityid,n)&&n.push(t.entityid),!0)});$("#filter-list h2.year").html("Year Range ("+a+"-"+l+")");var o={documents:i,entities:getEntityList(i)};if(e)return o;update(o)}function filterTitle(t,e){var r=$("#filter-title").val().toLowerCase(),a=[],l=t.documents.filter(function(t){return-1!=t.title.toLowerCase().indexOf(r)&&(-1==$.inArray(t.entityid,a)&&a.push(t.entityid),!0)}),n={documents:l,entities:getEntityList(l)};if(e)return n;update(n)}function getEntityList(t){var e={};for(var r in t){var a=t[r].entityid,l=t[r].links;e[a]=map_data.entities[a];for(var n in l){var i=l[n];e[i]||(e[i]=map_data.entities[i])}}return e}function clearJournalFilters(){$(".filter-item").removeClass("pinned"),$(".filter-item").css("background-color",""),hl_pinned=!1,hl_journal_id=null,$("#journal-filter .filter-item").remove(),selected_journals=[],applyFilters(!1)}function clearAuthorFilters(){$("#author-filter .filter-item").remove(),selected_authors=[],applyFilters(!1)}var journal={},journal_data={},author_data={},journal_entity_map={},entity_map={},selected_journals=[],selected_authors=[],hl_journal_id=null,hl_pinned=!1,selected_entity=[];d3.json("/journal",function(t,e){journal=e});