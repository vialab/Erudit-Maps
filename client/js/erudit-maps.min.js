function update(e){clearOverlays();var t=new google.maps.OverlayView;t.onAdd=function(){this.layer=d3.select(this.getPanes().overlayMouseTarget).append("div").attr("class","stations");d3.select(this.getPanes().overlayLayer).append("div").attr("class","SvgOverlay").append("svg").append("g").attr("class","AdminDivisions");t.draw=function(){function t(e){return node_coord[e.entityid]=[e.lat,e.lng],e=new google.maps.LatLng(e.lat,e.lng),e=o.fromLatLngToDivPixel(e),d3.select(this).style("left",e.x-s+"px").style("top",e.y-s+"px").style("z-index",99)}var o=this.getProjection(),s=10;for(this.layer.selectAll("svg").data(d3.values(e.entities)).each(t).enter().append("svg").each(t).attr("class","marker").attr("doc-id",function(e){return e.entityid}).attr("journal-id",function(e){return e.entityid}).on("mouseover",function(e){d3.select(this).selectAll("circle").attr("r",9).attr("fill","rgba(63, 184, 175, 0.8)").style("stroke","rgba(63, 184, 175, 1)")}).on("mouseout",function(e){d3.select(this).selectAll("circle").attr("r",4.5).attr("fill",rgb_highlight(e.entityid)).style("stroke",rgb_highlight)}).on("click",function(e){openDocumentsBar(e.entityid,e.affiliation)}).append("circle").attr("r",4.5).attr("cx",s).attr("cy",s).attr("fill",function(e){return rgb_highlight(e.entityid)}).attr("stroke",function(e){return rgb_highlight(e.entityid)!=rgb_default?"#000":rgb_stroke}),$("svg circle").tipsy({gravity:"w",html:!0,title:function(){return this.__data__.affiliation}}),$("svg circle").mousemove(function(e){$(".tipsy").css("left",e.pageX+16+"px"),$(".tipsy").css("top",e.pageY-16+"px")});polygons.length>0;)polygons.pop().setMap(null);for(;polylines.length>0;)polylines.pop().setMap(null);for(r=0;r<e.documents.length;r++)if(!(e.documents[r].links.length<2)){try{n=getGoogleCoords(e.documents[r].links)}catch(e){console.log(r)}var n=getGoogleCoords(e.documents[r].links);if(e.documents[r].links.length<3){var i=new google.maps.Polygon({path:n,geodesic:!0,strokeColor:rgb_highlight(e.documents[r].entityid),strokeOpacity:.8,strokeWeight:1});polylines.push(i)}else{var a=new google.maps.Polygon({paths:n,strokeColor:rgb_highlight(e.documents[r].entityid),strokeOpacity:.5,strokeWeight:1.5,fillColor:rgb_highlight(e.documents[r].entityid),fillOpacity:.1});polygons.push(a)}}for(r=0;r<polylines.length;r++)polylines[r].setMap(map);for(var r=0;r<polygons.length;r++)polygons[r].setMap(map)},t.onRemove=function(){this.layer.remove()}},overlays.push(t),t.setMap(map)}function clearOverlays(){for(var e=0;e<overlays.length;e++)overlays[e].setMap(null)}function getGoogleCoords(e){var t=[];e.length>1&&e.push(e[0]);for(var o=0;o<e.length;o++){if(o>0){var s=node_coord[e[o-1]][0],n=node_coord[e[o-1]][1],i=node_coord[e[o]][0],a=node_coord[e[o]][1],r=Math.abs(n-a);if(r>=180){var l=Math.abs(s-i)/5,d=r/5,c=1,g=1;for(n>a&&(g=-1),s>i&&(c=-1);n>a&&g<0||n<a&&g>0;)s+=l*c,n+=d*g,t.push(new google.maps.LatLng(s,n))}}t.push(new google.maps.LatLng(node_coord[e[o]][0],node_coord[e[o]][1]))}return t}function transformToGeoCollection(e){for(var t={type:"FeatureCollection",features:[]},o=0;o<e.length;o++)e[o].links.length>0&&t.features.push(transformToGeoFeature(e[o]));return t}function transformToGeoFeature(e){for(var t=[],o=0;o<e.links.length;o++)t.push([node_coord[e.links[o]][1],node_coord[e.links[o]][0]]);return t.push(t[0]),{type:"Feature",properties:{name:e.affiliation},geometry:{type:"Polygon",coordinates:[t]},id:"AFG"}}function pushInfoWidget(e){if($("#winfo-"+e.entityid).length>0)return!1;var t="<div class='tool-box-widget' id='winfo-"+e.entityid+"'>    <span class='widget-close' onclick='$(this).parent().remove();'>x</span><h2>"+e.affiliation+"</h2><p>Address: "+e.addr+"<br/>Lat: "+e.lat+"<br/>Lng: "+e.lng+"<br/><button class='ui button' onclick='openDocumentsBar("+e.entityid+',"'+e.affiliation+"\")'>View Documents</button></div>";return $("#tool-box").append(t),openSideBar(),!0}function openDocumentsBar(e,t){var o=getDocumentsByEntity(e);if($("#doc-modal").modal("show"),$("#doc-modal .header").html(t),0==o.length)return $("#doc-content").hide(),void $("#no-doc").show();$("#no-doc").hide(),$("#doc-content").show();for(var s="",n=0;n<o.length;n++){var i=map_data.entities[o[n].entityid].affiliation;s+="<div class='ui vertical segment doc-info'><h4>"+o[n].title+"</h4>Author: "+o[n].author+"<br/>",o[n].entityid!=e&&t!=i&&(s+="Affiliation: "+i+"<br/>"),s+="Journal: "+o[n].journal+"<br/>Year: "+o[n].year+"</div><br/>"}$("#doc-list").append(s)}function openFilterModal(){$("#filter-modal").modal("show")}function getDocumentsByEntity(e){return $.grep(filter_data.documents,function(t,o){return!(t.entityid!=e&&!$.inArray(e,t.links))})}function getAuthors(e){for(var t=[],o=0;o<e.length;o++){var s=e[o].authorid;t.includes(s)||t.push(s)}return t}function openSideBar(){$("#toggle-widgets i").removeClass("right"),$("#toggle-widgets i").addClass("left"),$("#widget-cards").css("left",0),$("#widget-cards").hasClass("opened")?$("#toggle-widgets").css("left",380):$("#toggle-widgets").css("left",370)}function closeSideBar(){$("#toggle-widgets i").removeClass("left"),$("#toggle-widgets i").addClass("right"),$("#widget-cards").css("left",-$("#widget-cards").width()-20),$("#toggle-widgets").css("left",-5)}function toggleSideBar(){+$("#widget-cards").css("left").replace("px","")<0?openSideBar():closeSideBar()}function openFilterBar(){$("#selected-filters .extra.content").hide(),$("#widget-cards #close-card").show(),$("#widget-cards").css("background-color","#eee"),$("#widget-cards").css("pointer-events","auto"),$("#widget-cards").css("overflow-y","scroll"),$("#widget-cards").addClass("opened"),$("#widget-cards").addClass("shadow"),$(".filter-widget").show(),$("#selected-filters").css("max-height","none"),$("#toggle-widgets").css("left",380)}function closeFilterBar(){$("#selected-filters .extra.content").show(),$("#widget-cards #close-card").hide(),$("#widget-cards").css("background-color","rgba(255,255,255,0)"),$("#widget-cards").css("pointer-events","none"),$("#widget-cards").css("overflow-y","hidden"),$("#widget-cards").removeClass("opened"),$("#widget-cards").removeClass("shadow"),$(".filter-widget").hide(),$("#selected-filters").css("max-height","280px"),$("#toggle-widgets").css("left",370)}function toggleFilterBar(){$("#widget-cards").hasClass("opened")?closeFilterBar():openFilterBar()}function showLinks(e){$("svg.links[doc-source='"+e+"']").show()}function hideLinks(e){void 0===e?$("svg.links").hide():$("svg.links[doc-source='"+e+"']").hide()}var $map=$("#map"),map=new google.maps.Map(d3.select("#map").node(),{zoom:3,center:new google.maps.LatLng(55,-72),mapTypeId:google.maps.MapTypeId.ROADMAP,mapTypeControl:!1,scaleControl:!1,streetViewControl:!1,zoomControl:!0,zoomControlOptions:{position:google.maps.ControlPosition.RIGHT_CENTER},styles:[{stylers:[{saturation:-60},{lightness:50}]}]}),map_data,filter_data,overlays=[],colors=["#e07b91","#d33f6a","#11c638","#8dd593","#c6dec7","#ead3c6","#f0b98d","#ef9708","#0fcfc0","#9cded6","#d5eae7","#f3e1eb","#f6c4e1","#f79cd4","#023fa5","#7d87b9","#bec1d4","#d6bcc0","#bb7784","#8e063b","#4a6fe3","#8595e1","#b5bbe3","#e6afb9"],color_scale=d3.scale.ordinal().range(colors),node_coord={},polygons=[],polylines=[];$(document).ready(function(){$("#tool-box").width(.2*$(window).width()),$("#filter-title").on("input",function(){applyFilters(!1)}),d3.json("/entities",function(e,t){if(e)throw e;filter_data=map_data=t,extractDateRange(map_data.documents),extractJournalList(map_data.documents),extractJournalEntity(map_data.documents),author_data=extractAuthorList(map_data.documents),drawAuthorList(),applyFilters(!1)})});